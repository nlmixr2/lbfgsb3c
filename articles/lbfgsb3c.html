<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>lbfgsb3c: Using the 2011 version of L-BFGS-B. • lbfgsb3c</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="lbfgsb3c: Using the 2011 version of L-BFGS-B.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">lbfgsb3c</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2024-3.5</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/lbfgsb3c.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nlmixr2/lbfgsb3c/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>lbfgsb3c: Using the 2011 version of L-BFGS-B.</h1>
                        <h4 data-toc-skip class="author">John C Nash
Telfer School of Management, University of Ottawa, <a href="mailto:nashjc@uottawa.ca" class="email">nashjc@uottawa.ca</a>
</h4>
            
            <h4 data-toc-skip class="date">October 22, 2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nlmixr2/lbfgsb3c/blob/v2024-3.5/vignettes/lbfgsb3c.Rmd" class="external-link"><code>vignettes/lbfgsb3c.Rmd</code></a></small>
      <div class="d-none name"><code>lbfgsb3c.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="abstract">Abstract<a class="anchor" aria-label="anchor" href="#abstract"></a>
</h2>
<p>In 2011 the authors of the L-BFGSB program published a correction and
update to their 1995 code. The latter is the basis of the L-BFGS-B
method of the <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> function in base-R. The package
<code>lbfgsb3</code> wrapped the updated code using a
<code>.Fortran</code> call after removing a very large number of Fortran
output statements. Matthew Fidler used this Fortran code and an
<code>Rcpp</code> interface to produce package <code>lbfgsb3c</code>
where the function <code><a href="../reference/lbfgsb3c.html">lbfgsb3c()</a></code> returns an object similar to
that of base-R <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> and that of
<code><a href="https://rdrr.io/pkg/optimx/man/optimr.html" class="external-link">optimx::optimr()</a></code>. Subsequently, in a fine example of the
collaborations that have made <strong>R</strong> so useful, we have
merged the functionality of package <code>lbfgsb3</code> into
<code>lbfgsb3c</code>, as explained in this vignette. Note that this
document is intended primarily to document our efforts to check the
differences in variants of the code rather than be expository.</p>
<div class="section level3">
<h3 id="provenance-of-the-r-optiml-bfgs-b-and-related-solvers">Provenance of the R optim::L-BFGS-B and related solvers<a class="anchor" aria-label="anchor" href="#provenance-of-the-r-optiml-bfgs-b-and-related-solvers"></a>
</h3>
<p>The base-R code lbfgsb.c (at writing in R-3.5.2/src/appl/) is
commented:</p>
<pre><code>/* l-bfgs-b.f -- translated by f2c (version 19991025).

  From ?optim:
  The code for method ‘"L-BFGS-B"’ is based on Fortran code by Zhu,
  Byrd, Lu-Chen and Nocedal obtained from Netlib (file 'opt/lbfgs_bcm.shar')

  The Fortran files contained no copyright information.

  Byrd, R. H., Lu, P., Nocedal, J. and Zhu, C.  (1995) A limited
  memory algorithm for bound constrained optimization.
  \emph{SIAM J. Scientific Computing}, \bold{16}, 1190--1208.
*/</code></pre>
<p>The paper <span class="citation">Byrd et al. (1995a)</span> builds on
<span class="citation">Lu et al. (1994)</span>. There have been a number
of other workers who have followed-up on this work, but
<strong>R</strong> code and packages seem to have largely stayed with
codes derived from these original papers. Though the date of the paper
is 1995, the ideas it embodies were around for a decade and a half at
least, in particular in Nocedal80 and LiuN89. The definitive Fortran
code was published as <span class="citation">Zhu et al. (1997)</span>.
This is available as <code>toms/778.zip</code> on www.netlib.org. A
side-by-side comparison of the main subroutines in the two downloads
from Netlib unfortunately shows a lot of differences. I have not tried
to determine if these affect performance or are simply cosmetic.</p>
<p>More seriously perhaps, there were some deficiencies in the code(s),
and in 2011 Nocedal’s team published a Fortran code with some
corrections (<span class="citation">Morales and Nocedal (2011)</span>).
Since the <strong>R</strong> code predates this, I prepared package
<code>lbfgsb3</code> (<span class="citation">Nash et al. (2015)</span>)
to wrap the Fortran code. However, I did not discover any test cases
where the <code>optim::L-BFGS-B</code> and <code>lbfgsb3</code> were
different, though I confess to only running some limited tests. There
are, in fact, more in this vignette.</p>
<p>In 2016, I was at a Fields Institute optimization conference in
Toronto for the 70th birthday of Andy Conn. By sheer serendipity,
Nocedal did not attend the conference, but sat down next to me at the
conference dinner. When I asked him about the key changes, he said that
the most important one was to fix the computation of the machine
precision, which was not always correct in the 1995 code. Since
<strong>R</strong> gets this number as <code>.Machine$double.eps</code>,
the offending code is irrelevant.</p>
<p>Within <span class="citation">Morales and Nocedal (2011)</span>,
there is also reported an improvement in the subspace minimization that
is applied in cases of bounds constraints. Since few of the tests I have
applied impose such constraints, it is reasonable that I will not have
observed performance differences between the base-R <code>optim</code>
code and my <code>lbfsgb3</code> package. More appropriate tests are
welcome, and on my agenda.</p>
<p>Besides the ACM TOMS code, there are two related codes from the
Northwestern team on NETLIB: <a href="https://netlib.org/opt/lbfgs_um.shar" class="external-link uri">https://netlib.org/opt/lbfgs_um.shar</a> is for
unconstrained minimization, while <a href="https://netlib.org/opt/lbfgs_bcm.shar" class="external-link uri">https://netlib.org/opt/lbfgs_bcm.shar</a> handles bounds
constrained problems. To these are attached references <span class="citation">Liu and Nocedal (1989)</span> and <span class="citation">Byrd et al. (1995b)</span> respectively, most likely
reflecting the effort required to implement the constraints.</p>
<p>The unconstrained code has been converted to <strong>C</strong> under
the leadership of Naoaki Okazaki (see <a href="http://www.chokkan.org/software/liblbfgs/" class="external-link uri">http://www.chokkan.org/software/liblbfgs/</a>, or the fork
at <a href="https://github.com/MIRTK/LBFGS" class="external-link uri">https://github.com/MIRTK/LBFGS</a>). This has been wrapped
for <strong>R</strong> as <span class="citation">Coppola, Stewart, and
Okazaki (2014)</span> as the <code>lbfgs</code> package. This can be
called from <code><a href="https://rdrr.io/pkg/optimx/man/optimr.html" class="external-link">optimx::optimr()</a></code>.</p>
<p>Using Rcpp (see <span class="citation">Eddelbuettel and François
(2011)</span>) and the Fortran code in package <code>lbfgs3</code>,
Matthew Fidler developed package <code>lbfgsb3c</code> (<span class="citation">Fidler et al. (2018)</span>). As this provides a more
standard call and return than <code>lbfgsb3</code> Fidler and I are
unified the two packages and released them both under the same name
<code>lbfgsb3c</code>.</p>
</div>
<div class="section level3">
<h3 id="functions-in-package-lbfgsb3c">Functions in package <code>lbfgsb3c</code><a class="anchor" aria-label="anchor" href="#functions-in-package-lbfgsb3c"></a>
</h3>
<p>There is really only one optimizer function in the package, but it
may be called by four (4) names:</p>
<ul>
<li>
<code><a href="../reference/lbfgsb3c.html">lbfgsb3c()</a></code> uses Rcpp (<span class="citation">Eddelbuettel (2013)</span>, <span class="citation">Eddelbuettel and François (2011)</span>, <span class="citation">Eddelbuettel and Balamuta (2017)</span>) to streamline
the call to the underlying Fortran. This is the base function used.</li>
<li>
<code><a href="../reference/lbfgsb3c.html">lbfgsb3x()</a></code> is an alias of <code><a href="../reference/lbfgsb3c.html">lbfgsb3c()</a></code>. We
were using this name for a while, and have kept the alias to avoid
having to edit test scripts.</li>
<li>
<code>lbfgsb3</code>, which imitates a <code>.Fortran</code> call of
the compiled 2011 Fortran code. The object returned by this routine is
NOT equivalent to the object returned by base-R <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> or
by <code><a href="https://rdrr.io/pkg/optimx/man/optimr.html" class="external-link">optimx::optimr()</a></code>. Instead, it includes a structure
<code>info</code> which contains the detailed diagnostic information of
the Fortran code. For most users, this is not of interest, and I only
recommend use of this function for those needing to examine how the
optimization has been carried out.</li>
<li>
<code><a href="../reference/lbfgsb3c.html">lbfgsb3f()</a></code> is an alias of <code>lbfsgb3()</code>.</li>
</ul>
<p>We recommend using the <code>lbfsgb3c()</code> call for most
uses.</p>
<div class="section level4">
<h4 id="candlestick-function">Candlestick function<a class="anchor" aria-label="anchor" href="#candlestick-function"></a>
</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># candlestick function</span></span>
<span><span class="co"># J C Nash 2011-2-3</span></span>
<span><span class="va">cstick.f</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">alpha</span><span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">r2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">f</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">r2</span><span class="op">+</span><span class="va">alpha</span><span class="op">/</span><span class="va">r2</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cstick.g</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">alpha</span><span class="op">=</span><span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">r2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">g1</span><span class="op">&lt;-</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span></span>
<span>  <span class="va">g2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">-</span><span class="va">alpha</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span><span class="op">/</span><span class="op">(</span><span class="va">r2</span><span class="op">*</span><span class="va">r2</span><span class="op">)</span></span>
<span>  <span class="va">g</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">g1</span><span class="op">+</span><span class="va">g2</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nlmixr2.github.io/lbfgsb3c/">lbfgsb3c</a></span><span class="op">)</span></span>
<span><span class="va">nn</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">lo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 10 10</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## c2o &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0))</span></span>
<span><span class="co">## print(summary(c2o, order=value))</span></span>
<span><span class="va">c2l1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">cstick.f</span>, <span class="va">cstick.g</span>, lower<span class="op">=</span><span class="va">lo</span>, upper<span class="op">=</span><span class="va">up</span><span class="op">)</span></span>
<span><span class="va">c2l1</span></span></code></pre></div>
<pre><code><span><span class="co">## $par</span></span>
<span><span class="co">## [1] 2.236068 2.236068</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">## [1] -1.121272e-06 -1.121272e-06</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 20</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 14 14</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## meths &lt;- c("L-BFGS-B", "lbfgsb3c", "Rvmmin", "Rcgmin", "Rtnmin")</span></span>
<span><span class="co">## require(optimx)</span></span>
<span></span>
<span><span class="co">## cstick2a &lt;- opm(x0, cstick.f, cstick.g, method=meths, upper=up, lower=lo, control=list(kkt=FALSE))</span></span>
<span><span class="co">## print(summary(cstick2a, par.select=1:2, order=value))</span></span>
<span><span class="va">lo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## c2ob &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0))</span></span>
<span><span class="co">## print(summary(c2ob, order=value))</span></span>
<span><span class="va">c2l2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">cstick.f</span>, <span class="va">cstick.g</span>, lower<span class="op">=</span><span class="va">lo</span>, upper<span class="op">=</span><span class="va">up</span><span class="op">)</span></span>
<span><span class="va">c2l2</span></span></code></pre></div>
<pre><code><span><span class="co">## $par</span></span>
<span><span class="co">## [1] 4 4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">## [1] 7.21875 7.21875</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 35.125</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 2 2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL"</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## cstick2b &lt;- opm(x0, cstick.f, cstick.g, method=meths, upper=up, lower=lo, control=list(kkt=FALSE))</span></span>
<span><span class="co">## print(summary(cstick2b, par.select=1:2, order=value))</span></span>
<span></span>
<span><span class="co">## nn &lt;- 100</span></span>
<span><span class="co">## x0 &lt;- rep(10, nn)</span></span>
<span><span class="co">## up &lt;- rep(10, nn)</span></span>
<span><span class="co">## lo &lt;- rep(1e-4, nn)</span></span>
<span><span class="co">## cco &lt;- opm(x0, cstick.f, cstick.g, lower=lo, upper=up, method=meths, control=list(trace=0, kkt=FALSE))</span></span>
<span><span class="co">## print(summary(cco, par.select=1:4, order=value))</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extended-rosenbrock-function-from-funconstrain">Extended Rosenbrock function (from funconstrain)<a class="anchor" aria-label="anchor" href="#extended-rosenbrock-function-from-funconstrain"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># require(funconstrain) ## not in CRAN, so explicit inclusion of this function</span></span>
<span><span class="co"># exrosen &lt;- ex_rosen()</span></span>
<span><span class="co"># exrosenf &lt;- exrosen$fn</span></span>
<span><span class="va">exrosenf</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">n</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span><span class="fl">2</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Extended Rosenbrock: n must be even"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">fsum</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">p2</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">i</span></span>
<span>        <span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">p2</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>        <span class="va">f_p1</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">*</span> <span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="va">p2</span><span class="op">]</span> <span class="op">-</span> <span class="va">par</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>        <span class="va">f_p2</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">par</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span></span>
<span>        <span class="va">fsum</span> <span class="op">&lt;-</span> <span class="va">fsum</span> <span class="op">+</span> <span class="va">f_p1</span> <span class="op">*</span> <span class="va">f_p1</span> <span class="op">+</span> <span class="va">f_p2</span> <span class="op">*</span> <span class="va">f_p2</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">fsum</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># exroseng &lt;- exrosen$gr</span></span>
<span><span class="va">exroseng</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">n</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span><span class="fl">2</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Extended Rosenbrock: n must be even"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">grad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">p2</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">i</span></span>
<span>        <span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">p2</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>        <span class="va">xx</span> <span class="op">&lt;-</span> <span class="va">par</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span> <span class="op">*</span> <span class="va">par</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span></span>
<span>        <span class="va">yx</span> <span class="op">&lt;-</span> <span class="va">par</span><span class="op">[</span><span class="va">p2</span><span class="op">]</span> <span class="op">-</span> <span class="va">xx</span></span>
<span>        <span class="va">f_p1</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">yx</span></span>
<span>        <span class="va">f_p2</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">par</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span></span>
<span>        <span class="va">grad</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grad</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">400</span> <span class="op">*</span> <span class="va">par</span><span class="op">[</span><span class="va">p1</span><span class="op">]</span> <span class="op">*</span> <span class="va">yx</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">f_p2</span></span>
<span>        <span class="va">grad</span><span class="op">[</span><span class="va">p2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">grad</span><span class="op">[</span><span class="va">p2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">200</span> <span class="op">*</span> <span class="va">yx</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">grad</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">exrosenx0</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">n</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span><span class="fl">2</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Extended Rosenbrock: n must be even"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">n</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://nlmixr2.github.io/lbfgsb3c/">lbfgsb3c</a></span><span class="op">)</span></span>
<span><span class="co">## require(optimx)</span></span>
<span></span>
<span><span class="co">## require(optimx)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">n</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">12</span>, by<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ex_rosen try for n="</span>,<span class="va">n</span>,<span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu">exrosenx0</span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">lo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="va">up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">3</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"optim L-BFGS-B\n"</span><span class="op">)</span></span>
<span>  <span class="va">eo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">exrosenf</span>, <span class="va">exroseng</span>, lower<span class="op">=</span><span class="va">lo</span>, upper<span class="op">=</span><span class="va">up</span>, method<span class="op">=</span><span class="st">"L-BFGS-B"</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">eo</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"lbfgsb3c\n"</span><span class="op">)</span></span>
<span>  <span class="va">el</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">exrosenf</span>, <span class="va">exroseng</span>, lower<span class="op">=</span><span class="va">lo</span>, upper<span class="op">=</span><span class="va">up</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">el</span><span class="op">)</span></span>
<span><span class="co">##    erfg &lt;- opm(x0, exrosenf, exroseng, method=meths, lower=lo, upper=up)</span></span>
<span><span class="co">##    print(summary(erfg, par.select=1:2, order=value))</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## ex_rosen try for n= 2 </span></span>
<span><span class="co">## [1] -1.2  1.0</span></span>
<span><span class="co">## optim L-BFGS-B</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 3.844416e-14</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## function gradient </span></span>
<span><span class="co">##       51       51 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## lbfgsb3c</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">## [1] -8.65458e-07  6.26284e-07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 3.844419e-14</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 51 51</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ex_rosen try for n= 4 </span></span>
<span><span class="co">## [1] -1.2  1.0 -1.2  1.0</span></span>
<span><span class="co">## optim L-BFGS-B</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 7.688835e-14</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## function gradient </span></span>
<span><span class="co">##       51       51 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## lbfgsb3c</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">## [1] -8.65458e-07  6.26284e-07 -8.65458e-07  6.26284e-07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 7.688829e-14</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 51 51</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ex_rosen try for n= 6 </span></span>
<span><span class="co">## [1] -1.2  1.0 -1.2  1.0 -1.2  1.0</span></span>
<span><span class="co">## optim L-BFGS-B</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 1.153325e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## function gradient </span></span>
<span><span class="co">##       51       51 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## lbfgsb3c</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">## [1] -8.654581e-07  6.262840e-07 -8.654581e-07  6.262840e-07 -8.654581e-07</span></span>
<span><span class="co">## [6]  6.262840e-07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 1.153324e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 51 51</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ex_rosen try for n= 8 </span></span>
<span><span class="co">## [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0</span></span>
<span><span class="co">## optim L-BFGS-B</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 1.537767e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## function gradient </span></span>
<span><span class="co">##       51       51 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## lbfgsb3c</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">## [1] 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">## [1] -8.65458e-07  6.26284e-07 -8.65458e-07  6.26284e-07 -8.65458e-07</span></span>
<span><span class="co">## [6]  6.26284e-07 -8.65458e-07  6.26284e-07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 1.537766e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 51 51</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ex_rosen try for n= 10 </span></span>
<span><span class="co">##  [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0</span></span>
<span><span class="co">## optim L-BFGS-B</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">##  [1] 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 1.922208e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## function gradient </span></span>
<span><span class="co">##       51       51 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## lbfgsb3c</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">##  [1] 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">##  [1] -8.654582e-07  6.262840e-07 -8.654582e-07  6.262840e-07 -8.654582e-07</span></span>
<span><span class="co">##  [6]  6.262840e-07 -8.654582e-07  6.262840e-07 -8.654582e-07  6.262840e-07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 1.922207e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 51 51</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## ex_rosen try for n= 12 </span></span>
<span><span class="co">##  [1] -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0 -1.2  1.0</span></span>
<span><span class="co">## optim L-BFGS-B</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">##  [1] 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 2.306652e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## function gradient </span></span>
<span><span class="co">##       51       51 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## lbfgsb3c</span></span>
<span><span class="co">## $par</span></span>
<span><span class="co">##  [1] 1 1 1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $grad</span></span>
<span><span class="co">##  [1] -8.654581e-07  6.262840e-07 -8.654581e-07  6.262840e-07 -8.654581e-07</span></span>
<span><span class="co">##  [6]  6.262840e-07 -8.654581e-07  6.262840e-07 -8.654581e-07  6.262840e-07</span></span>
<span><span class="co">## [11] -8.654581e-07  6.262840e-07</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $value</span></span>
<span><span class="co">## [1] 2.306649e-13</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $counts</span></span>
<span><span class="co">## [1] 51 51</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $convergence</span></span>
<span><span class="co">## [1] 0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $message</span></span>
<span><span class="co">## [1] "CONVERGENCE: REL_REDUCTION_OF_F_&lt;=_FACTR*EPSMCH"</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="using-compiled-function-code">Using compiled function code<a class="anchor" aria-label="anchor" href="#using-compiled-function-code"></a>
</h3>
<p>While you may use the same interface as described in the writing R
extensions to interface compiled code with this function, see <a href="https://cran.r-project.org/doc/manuals/r-release/R-exts.html#Optimization" class="external-link">L-BFGS-B</a>,
it is sometimes more convenient to use your own compiled code.</p>
<p>The following example shows how this is done using the file
<code>jrosen.f</code>. We have unfortunately found that compilation is
not always portable across systems, so this example is presented without
execution.</p>
<pre><code>       subroutine rosen(n, x, fval)
       double precision x(n), fval, dx
       integer n, i
       fval = 0.0D0
       do 10 i=1,(n-1)
          dx = x(i + 1) - x(i) * x(i)
          fval = fval + 100.0 * dx * dx
          dx = 1.0 - x(i)
          fval = fval + dx * dx
 10    continue
       return
       end</code></pre>
<p>Here is the example script. Note that we must have the file
<code>jrosen.f</code> available. Because the executable files on
different systems use different conventions and structures, we have
turned evaluation off here so this vignette can be built on multiple
platforms. However, we wished to provide examples of how compiled code
could be used.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html" class="external-link">system</a></span><span class="op">(</span><span class="st">"R CMD SHLIB jrosen.f"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dynload.html" class="external-link">dyn.load</a></span><span class="op">(</span><span class="st">"jrosen.so"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dynload.html" class="external-link">is.loaded</a></span><span class="op">(</span><span class="st">"rosen"</span><span class="op">)</span></span>
<span><span class="va">x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="op">-</span><span class="fl">999</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">testf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Foreign.html" class="external-link">.Fortran</a></span><span class="op">(</span><span class="st">"rosen"</span>, n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span>, fval<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">fv</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">testf</span></span>
<span></span>
<span><span class="va">rrosen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fval</span> <span class="op">&lt;-</span> <span class="fl">0.0</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dx</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">fval</span> <span class="op">&lt;-</span> <span class="va">fval</span> <span class="op">+</span> <span class="fl">100.0</span> <span class="op">*</span> <span class="va">dx</span> <span class="op">*</span> <span class="va">dx</span></span>
<span>    <span class="va">dx</span> <span class="op">&lt;-</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">fval</span> <span class="op">&lt;-</span> <span class="va">fval</span> <span class="op">+</span> <span class="va">dx</span> <span class="op">*</span> <span class="va">dx</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">fval</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="op">(</span><span class="fu">rrosen</span><span class="op">(</span><span class="va">x0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">frosen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">nn</span> <span class="op">&gt;</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"max number of parameters is 100"</span><span class="op">)</span><span class="op">}</span></span>
<span>  <span class="va">fv</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">999.0</span></span>
<span>  <span class="va">val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Foreign.html" class="external-link">.Fortran</a></span><span class="op">(</span><span class="st">"rosen"</span>, n<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">nn</span><span class="op">)</span>, x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, fval<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">fv</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">val</span><span class="op">$</span><span class="va">fval</span> <span class="co"># NOTE--need ONLY function value returned</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># Test the funcion</span></span>
<span><span class="va">tval</span> <span class="op">&lt;-</span> <span class="fu">frosen</span><span class="op">(</span><span class="va">x0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">tval</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run with Nelder-Mead using R function\n"</span><span class="op">)</span></span>
<span><span class="va">mynm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">rrosen</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mynm</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n\n Run with Nelder-Mead using Fortran function"</span><span class="op">)</span></span>
<span><span class="va">mynmf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">frosen</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mynmf</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nlmixr2.github.io/lbfgsb3c/">lbfgsb3c</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"try lbfgsb3c, no Gradient \n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"R function\n"</span><span class="op">)</span></span>
<span><span class="va">tlR</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="va">myopR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">rrosen</span>, gr<span class="op">=</span><span class="cn">NULL</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tlR</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">myopR</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fortran function\n"</span><span class="op">)</span></span>
<span><span class="va">tlF</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span><span class="va">myop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lbfgsb3c.html">lbfgsb3c</a></span><span class="op">(</span><span class="va">x0</span>, <span class="va">frosen</span>, gr<span class="op">=</span><span class="cn">NULL</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tlF</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">myop</span><span class="op">)</span></span></code></pre></div>
<p>In this example, Fortran execution was actually SLOWER than plain R
on the system where it was run.</p>
</div>
<div class="section level3">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Byrd95" class="csl-entry">
Byrd, Richard H., Peihuang Lu, Jorge Nocedal, and Ci You Zhu. 1995a.
<span>“A Limited Memory Algorithm for Bound Constrained
Optimization.”</span> <em>SIAM Journal on Scientific Computing</em> 16
(5): 1190–1208.
</div>
<div id="ref-Byrd1995" class="csl-entry">
Byrd, Richard H., Peihuang Lu, Jorge Nocedal, and Ciyou Zhu. 1995b.
<span>“A Limited Memory Algorithm for Bound Constrained
Optimization.”</span> <em>SIAM J. Sci. Comput.</em> 16 (5): 1190–1208.
<a href="https://doi.org/10.1137/0916069" class="external-link">https://doi.org/10.1137/0916069</a>.
</div>
<div id="ref-Coppola2014" class="csl-entry">
Coppola, Antonio, Brandon Stewart, and Naoaki Okazaki. 2014. <em>Lbfgs:
Limited-Memory BFGS Optimization</em>. <a href="https://CRAN.R-project.org/package=lbfgs" class="external-link">https://CRAN.R-project.org/package=lbfgs</a>.
</div>
<div id="ref-RCppDE2013" class="csl-entry">
Eddelbuettel, Dirk. 2013. <em>Seamless <span>R</span> and
<span>C++</span> Integration with <span>Rcpp</span></em>. New York:
Springer. <a href="https://doi.org/10.1007/978-1-4614-6868-4" class="external-link">https://doi.org/10.1007/978-1-4614-6868-4</a>.
</div>
<div id="ref-RCppDEJJB2017" class="csl-entry">
Eddelbuettel, Dirk, and James Joseph Balamuta. 2017. <span>“<span class="nocase">Extending extit<span>R</span> with extit<span>C++</span>:
A Brief Introduction to extit<span>Rcpp</span></span>.”</span> <em>PeerJ
Preprints</em> 5 (August): e3188v1. <a href="https://doi.org/10.7287/peerj.preprints.3188v1" class="external-link">https://doi.org/10.7287/peerj.preprints.3188v1</a>.
</div>
<div id="ref-RCppDERF2011" class="csl-entry">
Eddelbuettel, Dirk, and Romain François. 2011. <span>“<span>Rcpp</span>:
Seamless <span>R</span> and <span>C++</span> Integration.”</span>
<em>Journal of Statistical Software</em> 40 (8): 1–18. <a href="https://doi.org/10.18637/jss.v040.i08" class="external-link">https://doi.org/10.18637/jss.v040.i08</a>.
</div>
<div id="ref-lbfgsb3cMF" class="csl-entry">
Fidler, Matthew L, John C Nash, Ciyou Zhu, Richard Byrd, Jorge Nocedal,
and Jose Luis Morales. 2018. <em><span class="nocase">lbfgsb3c</span>:
Limited Memory BFGS Minimizer with Bounds on Parameters with Optim() ’c’
Interface</em>. <a href="https://CRAN.R-project.org/package=lbfgsb3c" class="external-link">https://CRAN.R-project.org/package=lbfgsb3c</a>.
</div>
<div id="ref-LiuN89" class="csl-entry">
Liu, Dong C., and Jorge Nocedal. 1989. <span>“On the Limited Memory
<span>BFGS</span> Method for Large Scale Optimization.”</span> <em>Math.
Program.</em> 45 (1-3): 503–28. <a href="https://doi.org/10.1007/BF01589116" class="external-link">https://doi.org/10.1007/BF01589116</a>.
</div>
<div id="ref-Lu94limitedmemory" class="csl-entry">
Lu, Peihuang, Jorge Nocedal, Ciyou Zhu, and Richard H. Byrd. 1994.
<span>“A Limited-Memory Algorithm for Bound Constrained
Optimization.”</span> <em>SIAM Journal on Scientific Computing</em> 16:
1190–1208.
</div>
<div id="ref-Morales2011" class="csl-entry">
Morales, José Luis, and Jorge Nocedal. 2011. <span>“Remark on <span class="nocase">Algorithm 778: L-BFGS-B: Fortran subroutines for
large-scale bound constrained optimization</span>.”</span> <em>ACM
Trans. Math. Softw.</em> 38 (1): 7:1–4.
</div>
<div id="ref-lbfgsb3JN" class="csl-entry">
Nash, John C, Ciyou Zhu, Richard Byrd, Jorge Nocedal, and Jose Luis
Morales. 2015. <em><span class="nocase">lbfgsb3</span>: Limited Memory
BFGS Minimizer with Bounds on Parameters</em>. <a href="https://CRAN.R-project.org/package=lbfgsb3" class="external-link">https://CRAN.R-project.org/package=lbfgsb3</a>.
</div>
<div id="ref-Zhu1997LBFGS" class="csl-entry">
Zhu, Ciyou, Richard H. Byrd, Peihuang Lu, and Jorge Nocedal. 1997.
<span>“Algorithm 778: <span>L-BFGS-B</span>: Fortran Subroutines for
Large-Scale Bound-Constrained Optimization.”</span> <em>ACM Trans. Math.
Softw.</em> 23 (4): 550–60. <a href="https://doi.org/10.1145/279232.279236" class="external-link">https://doi.org/10.1145/279232.279236</a>.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew L Fidler, John C Nash, Ciyou Zhu, Richard Byrd, Jorge Nocedal, Jose Luis Morales.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
